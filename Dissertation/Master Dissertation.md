Author: Danila Moskvitin
Supervisor: Sergei Savin

## Chapter 1 - First steps

Итак, я начинаю работу над ВКР магистра. Будем разбираться с **MPPI** методом и пытаться на его основе создать нечто. MPPI (Model Predictive Path Integral) - это стохастический метод оптимального управления, разновидность Model Predictive Control.

Вот ключевые моменты:
- **Стратегия**: в каждый шаг алгоритм генерирует множество случайных команд управления (например, руление + скорость), прогоняет для каждой модель динамики на некотором горизонте, вычисляет стоимость траекторий (целевая функция — расстояние до цели, избегание препятствий и др.), и усредняет команды с весами, зависящими от стоимости (лучшие — тяжелее).
- **Преимущества**: не требует дифференцируемости модели и стоимости, может учитывать нефункциональные ограничения, работает с нелинейными системами. 
- **Ограничения**: высокая вычислительная нагрузка зависит от количества сэмплов, может давать "рывки" в управлении без сглаживания.

И так кратко о методе **MPPI**:

### MPPI - (Model Predictive Path Integral)

[Оригинальная работа][Model Predictive Path Integral Control using Covariance Variable Importance Sampling]

Как я понял этот метод. Все, что необходимо - это модель (желательно идеальная), номинальное управление и много вычислительных ресурсов. Предположим, что у нас есть машинка с компьютером на ней. Машинка едет-едет и имеет номинальное управление, она просчитывает будущие состояния $x_t$ с управлением $u_t$ при помощи имеющейся модели на заданное число шагов вперед - горизонт $T$, но помимо этого добавляет на каждом шаге случайный шум $\delta u_n \in N (0, \Sigma)$, таким образом мы получаем "roll out" (траекторию просчитанную в будущее). А если сделать много таких вычислений и получить тысячи немного отличающихся траекторий, то можно создать из них лучшую и выбрать управление, соответствующее этой траектории. Лучшая траектория будет взвешенной суммой всех траекторий, при помощи оценки траектории (score, reward или cost) мы сможем определить важность каждой из них. Пусть динамика системы задаётся уравнением $x_{t+1} = f(x_t, u_t)$, а функция стоимости вдоль траектории с горизонтом $T$ имеет вид:
$$
S = \phi(x_T ) + \sum_{t=0}^{T-1}{l(x_t,u_t)}$$ где $l$ – мгновенная (промежуточная) стоимость, $\phi$ – терминальная. Цель – минимизировать J = minu E[S] $J = {min}_u \mathbb{E}$. В подходе path-integral по Лоуренсу (**TODO** изучить) решение через функцию стоимости превращается в ожидание по случайным траекториям. Практически это означает, что мы аппроксимируем оптимальное управление через набор симулированных реализаций. Для каждого сценария $k = 1..K$ генерируем возмущённое управление:
$$u_t^{(k)} = u_t^{nom} + \delta u_t^{(k)}$$ , где $\delta u_t^{(k)} \sim \mathcal{N}(0, \Sigma)$. Моделируем:
$$x (k) t+1 = f(x (k) t , u (k) t )$$
и вычисляем его суммарную стоимость $S_k$ . Мы даем каждой траектории вес для определения ее важности: 
$${\omega}_k = exp(− \frac{S_k}{\lambda} ),$$ 
где $S_k$ - оценка траектории (score), $\lambda$ (температура) - параметр, регулирующий функцию экспоненты. Чем меньше $S_k$, тем больший вклад траектория имеет в итоговый результат. И так машинка едет и имеет результирующее управление вида:
$$u_t \leftarrow u_t + \frac{\sum_{k=1}^{K}{{\omega}_k \delta u_t^{(k)}}}{\sum_{k=1}^{K}{{\omega}_k}}$$ 
Видно, что не нужно брать производные и это означает, что учитываются все нелинейности модели. Важно, что все эти операции легко распараллеливаются по траекториям, что требует большой вычислительной мощности (обычно используются GPU).

## Literature

[**Исходная работа.**][Model Predictive Path Integral Control using Covariance Variable Importance Sampling] Метод MPPI впервые был предложен Уильямсом и др. в 2016 г. (ICRA 2016). В этой работе представлены теоретические основы, описан алгоритм с GPU параллелизацией и проведено сравнение с MPC-DDP (дифференциальным динамическим программированием). Авторы показали, что MPPI благодаря безградиентному стохастическому поиску лучше учитывает нелинейности и позволяет использовать произвольные функции стоимости, а также превосходит DDP в некоторых сложных задачах (например, внедорожная езда).

[**Устойчивость к помехам (RMPPI).**][Robust Model Predictive Path Integral Control: Analysis and Performance Guarantees] Gandhi et al. предложили Robust MPPI (RAL 2021) – архитектуру, учитывающую несоответствия модели и использующую параллельные треки «номинального» и «реального» состояний. RMPPI обеспечивает гарантии по нарушению функций стоимости и комбинирует агрессивное и консервативное поведение. В экспериментах на внедорожном роботе показано, что RMPPI выигрывает у стандартного MPPI и Tube-MPPI по сочетанию производительности и робастности.

[**Снижение дисперсии (Tsallis-MPPI).**][Variational Inference MPC using Tsallis Divergence] В RSS 2021 была представлена версия MPPI на основе дивергенции Цаллиса (Tsallis VI-MPC). Этот подход вводит гиперпараметр «доли элитного множества» и позволяет объединять методы CEM (метод кроссэнтропии) и MPPI. В работе показано, что Tsallis-MPPI даёт лучшие средние результаты и меньшую дисперсию стоимостей по сравнению со стандартным MPPI и CEM, особенно в сложных высокоразмерных задачах . Иначе говоря, использование статистики Цаллиса помогает управлять распределением сэмплированных траекторий и улучшает надёжность.

[**Сглаживание и другие улучшения.**][π-MPPI: A Projection-based Model Predictive Path Integral Scheme for Smooth Optimal Control of Fixed-Wing Aerial Vehicles] Для снятия «рывков» управления введены различные модификации. Например, π-MPPI (IROS 2023) включает проекцию с помощью фильтра на траектории управления (высшие производные), что даёт более гладкий сигнал . Tube-MPPI (RSS 2018) и другие варианты добавляют жёсткие ограничения на неопределённость и гарантии соблюдения траектории. Кроме того, рассматриваются обобщения на нелинейную стохастику, многозадачные системы и т.д. (например, MPPI применяют в системе распределённого управления и активного вывода, многомодальные MPPI)

[**MPPI контроллер для БПЛА.**][Model Predictive Path Integral Control for Agile Unmanned Aerial Vehicles] Авторы (Minarik, Penicka, Vonasek, Saska) представляют MPPI-контроллер, предназначенный для агрессивного полета UAV в условиях плотной среды (пролеты через узкие окна, высокая скорость, быстрые манёвры), при этом расчёт выполняется полностью на борту на GPU (Jetson Orin Nano) с частотой ∼ 100 Гц и без помощи внешних компьютеров. Это первый известный пример применения MPPI вживую на БПЛА, достигая скорости до 44 км/ч и ускорения $ \sim 20 \text{ м/с}^2$, с одновременным учётом динамики и избеганием препятствий.

[**Двойной отжиг (DIAL-MPC).**][Full-Order Sampling-Based MPC for Torque-Level Locomotion Control via Diffusion-Style Anneng] Метод DIAL-MPC, предложенный Xue et al. оптимизирует полную динамическую модель ходячего робота (на уровне крутящих моментов) без прибегания к упрощениям модели. Мотивация — обеспечить эффективный онлайнконтроль в высокоразмерных контактно-динамических системах, где классический NMPC с полной моделью слишком медлителен, а стандартный MPPI при фиксированной дисперсии часто застревает в локальных оптимумах. DIAL-MPC вводит «диффузионно-стильный отжиг»: управление итеративно уточняется от размытых приближений к истинной целевой функции. Иными словами, сначала оптимизируется усреднённый (сглаженный) вариант задачи, а затем постепенно возвращается к исходному J(u). В результате достигается баланс между глобальным исследованием пространства управления и сходимостью к оптимуму. Эксперименты показывают, что DIAL-MPC на квадрупеде уменьшает ошибку траектории в ∼ 13.4× по сравнению со стандартным MPPI и превосходит RL-подходы примерно на 50% в сложных задачах (например, лазании с нагрузкой) без обучения. В частности, метод позволяет точно выполнять прыжки квадрупеда с дополнительной нагрузкой. По утверждению авторов, DIAL-MPC — первый train-free метод, который в реальном времени оптимизирует полную (18 DOF) модель квадрупеда на уровне крутящих моментов.

[**Planner-Estimator MPPI.**][A fault-tolerant and robust controller using model predictive path integral control for free-flying space robots] В статье Raisi, Noohian и Fallah (2022) представлен Planner‑Estimator MPPI (PE‑MPPI) — расширение классического MPPI, специально адаптированное для свободноплавающих космических робототехнических манипуляторов (free-flying space robots) при наличии отказов и параметрической неопределённости. MPPI чувствителен к несовпадению между моделью и реальной динамикой. При неправильных параметрах модельных roll-outs, веса траекторий обнуляются, и управление становится неэффективным. Оценщик компенсирует это, обновляя модель так, чтобы планировщик получал более точное предсказание. В статье показано, что PE‑MPPI остается стабильным и точным даже при отказе приводов и резком изменении массы в фазе pre-capture миссии по удалению мусора.

## Practice

Существуют репозитории GitHub, в которых наглядно показан MPPI метод:

1. [MizuhoAOKI/python_simple_mppi][https://github.com/MizuhoAOKI/python_simple_mppi] - работает без дополнительных исправлений. Примеры: машинка, машинка с препятствиями, cartpole, сравнение с MPPI и без. отличный базовый вариант для понимания. Jupiter Notebook.
2. [taherfattahi/mppi-2d-car-navigation-with-obstacles][https://github.com/taherfattahi/mppi-2d-car-navigation-with-obstacles] - работает без исправлений. Красивая визуализация, комментарии к коду. Пример: машинка с препятствиями. Python File.
3. [UM-ARM-Lab/pytorch_mppi][https://github.com/UM-ARM-Lab/pytorch_mppi] - in progress
4. [kohonda/mppi_playground][https://github.com/kohonda/mppi_playground] - in progress

Различные имплементации MPPI:

1. [NAV2 documentation][https://docs.nav2.org/configuration/packages/configuring-mppic.html] - in progress
## References

1. [Model Predictive Path Integral Control using Covariance Variable Importance Sampling](https://arxiv.org/pdf/1509.01149)
2. [Robust Model Predictive Path Integral Control: Analysis and Performance Guarantees][https://arxiv.org/pdf/2102.09027]
3. [Variational Inference MPC using Tsallis Divergence][https://www.roboticsproceedings.org/rss17/p073.pdf]
4. [π-MPPI: A Projection-based Model Predictive Path Integral Scheme for Smooth Optimal Control of Fixed-Wing Aerial Vehicles][https://arxiv.org/pdf/2504.10962v1]
5. [Model Predictive Path Integral Control for Agile Unmanned Aerial Vehicles][https://arxiv.org/pdf/2407.09812v1]
6. [Full-Order Sampling-Based MPC for Torque-Level Locomotion Control via Diffusion-Style Anneng][https://arxiv.org/pdf/2409.15610]
7. [A fault-tolerant and robust controller using model predictive path integral control for free-flying space robots][https://www.frontiersin.org/journals/robotics-and-ai/articles/10.3389/frobt.2022.1027918/full]